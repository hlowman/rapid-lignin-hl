---
title: "LMEMs-lignin"
author: "Heili Lowman"
date: "1/20/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Linear Mixed Effect Models

This document was last updated on JANUARY 23, 2020.

This is an R Markdown document that will walk through all of the LMEMs run for Chapter 3 of my dissertation and the resulting manuscript.

Model creation begins with fixed effects and random effects using a random intercept structure. Then, model selection follows the protocol outlined by Zuur et al. (2009, Chapter 5), beginning with a linear model, accounting for variance structure, optimizing the fixed structure, and validating best model fit using distribution of residuals and AIC values. All 24 of the below models follow the same format.

```{r data and packages, include=FALSE}

master <- read.csv("RAPID_Master_Datasheet_add_region_streamcode.csv") # Loads the newly updated dataset, as of April 8, 2019. 

#Some of the column headers have been changed, including the ones containing the "micro" symbol, which R apparently cannot process. 
#LTER_Site column - added so that naming convention is consistent, especially among stream sites which were entered differently in the "Site" column.
#Group_2 column - added to split reef sites into groupings near and far from streams by date. 
#Group_3 column - added to create regions from west to east as discussed with Matthieu.
# In addition, all NDs from Matthieu's original reports are replaced as NAs.

library(tidyverse)
library(nlme)
library(multcomp)
library(lsmeans)

```

First, I reviewed all of the columns that were added manually to the original dataset to make data grouping by date easier.

Next, I am going to review the data in the tidyverse and make sure everything is in the correct numerical format and remove outliers for the *entirety* of the dataset.

```{r tidying up, include=FALSE}

# Format

str(master) # Shows the format of each of the columns in the dataset.

# Need to make Depth and Group_3 factors and convert C.N, C, and P numeric.

master$Depthf <- as.factor(master$Depth) # Makes the water depth column a series of factors.

master$Group_3f <- as.factor(master$Group_3) # Makes the regional column a series of factors.

# I don't actually use the following columns in the analysis, but figured it's best to make these transformations just in case.

master$C.Nnum <- as.numeric(master$C.N) # Makes the C:N column a series of numbers.

master$Cnum <- as.numeric(master$C) # Makes the cinnamyl column a series of numbers.

master$Pnum <- as.numeric(master$P) # Makes the p-phenol column a series of numbers.

# NAs and 0s

# The only "<0.01"s appear to be in the "C" column, so going to leave those since this column is not being analyzed in this code.

# Upon further inspection of the dataset, I feel it makes the most sense to only alter those columns that are needed for the below analysis, so that's what I'll do. See below:

# See e-mail correspondence with Matthieu on 1/22/2020: "ND does not mean 0. When doing analytical measurements using GC/MS or others detectors you never can say that you have 0. Indeed, due to analytical issues you have limits of quantification and limits of detection. To summarize, when you are under LOD, it does not mean that you do not have the presence of the analyte but that you cannot decipher it from the background."

# So, all NAs that were previously NDs will be left as such since they are not actually a 0 value.

# Outliers based on past models. I'm going to work through these and take a more conservative approach with removing outliers from the whole dataset.

  # full (6)
  # Sigma8 - 66
  # Lambda - 164, 238 (choosing to keep in 161)
  # S/V - 387 (choosing to keep in 282, 299, 301, 443)
  # C/V - 389
  # PVS - (choosing to keep in 21, 23)
  # BdV - 300

  # marine (1)
  # Sigma8 - 56, 172 (238), (choosing to keep in 301 (367))
  # Lambda - 172 (238) (choosing to keep in 374 (454))

  # stream (0)
  # Sigma8 - 2 (66)

  # estuary (0)
  # CV - 47 (389)

# Alright, so the seven outliers I'm removing will be 56, 66, 164, 238, 300, 387, and 389 from the original dataset. I'll work backwards to preserve line numbers.

mastered <- master[ -c(56, 66, 164, 238, 300, 387, 389), ] # Starts with the original dataset and then removes desired rows.

```

These models will be organized in this file as they are listed in Appendix 4 of the manuscript.

# Entire Dataset

## Sigma 8

```{r Sigma, echo = FALSE}

### Data Exploration

# I'm examining Region, Ecosystem Type (Stream, Estuarine, and Marine), Site, and Date as factors influencing lignin oxidation results. Here are the boxplots and pairplots necessary.

boxplot(Sigma8 ~ Group_3f, data = mastered) # Boxplot by region. In past iterations, this was determined not to be a significant factor, but I am going to keep it in the workflow as a potential fixed effect for now.
boxplot(Sigma8 ~ Environment, data = mastered) # Boxplot by environment. Fixed effect.
boxplot(Sigma8 ~ LTER_Site, data = mastered) # Boxplot by site. Random effect.
boxplot(Sigma8 ~ Group, data = mastered) # Boxplot by sampling date. Group lumps everything sampled on a single date together - the HUGE problem with this sampling design is that the sampling dates are SUPER closely correlated with Environment. Random effect (since there may be an effect across time, but one that may be indistiguishable from Environment).

# New dataset.

sig <- mastered %>%
  dplyr::select(Group_3f, Environment, LTER_Site, Group, Sigma8) %>%
  na.omit # remove NAs and create new dataset.

pairs(sig) # Pairs plot.

sig$Environment <- factor(sig$Environment, levels = c("Stream", "Estuary", "Reef")) # Relevels for simpler labeling later.

#### STEP 1: Create a linear regression and check residuals.

# Reasoning for log-transforming Sigma values: per Chapter 19 of Zuur et al. 2009, I'm going to log transform the Sigma data because otherwise (using different variance structures) you are giving up lots of degrees of freedom and make GLS estimation unstable. And I KNOW homogeneity is an issue based on past attempts and the sheer spread of values. I know that this changes the values, but this will give me more flexibility in exploring explanatory variables, which I think is more important that the values themselves.

sig$logSigma8 <- log10(sig$Sigma8) # Log transform data to make heterogeneity of residuals a non-issue (hopefully).

op<- par(mfrow = c(1, 2), mar = c(3, 4, 1, 1))
dotchart(sig$Sigma8, groups = sig$LTER_Site) # Sigma8 versus Site on left.
dotchart(sig$logSigma8, groups = sig$LTER_Site) # Log(Sigma8) versus Site on right.
par(op) # Looking better! And I've deemed the negative values to be A-OK since it's not a Poisson distribution (according to Ana MtK).

# Based on boxplots & pairplots : 
# Response variables - logSigma8
# Explanatory (fixed) variables - Group_3f, Environment

a1 <- lm(logSigma8 ~ Group_3f + Environment, data = sig) # Creates the initial linear model with both fixed variables.
ra1 <- rstandard(a1) # Assigns standardized residuals to eeee.
plot(ra1 ~ sig$LTER_Site, xlab = "Site",
     ylab = "Standardised residuals") # Plots said residuals.
abline(0,0) # Since some boxplots are totally above/below zero, there is within-site correlation, so it WILL be used as a random effect as part of the random intercept model structure.

plot(ra1 ~ sig$Group, xlab = "Date",
     ylab = "Standardised residuals") # Plots said residuals.
abline(0,0) # Group looks less important so removing sampling date as a random effect.

#### STEP 2: Fit the lm() with GLS and compare to lme().

a2 <- gls(logSigma8 ~ Group_3f + Environment, data = sig) # This is effectively a linear regression since it has no additional calls.
a3 <- lme(logSigma8 ~ Group_3f + Environment, random =~1 | LTER_Site, data = sig) # Creates the first LMEM with nested random term.
anova(a2, a3) # Compares the two models. a3 preferred with AIC value of 741.60.

# STEP 3: Decide on a variance structure (aka random terms).

plot(a3, col=1) # Check the residuals before jumping right to applying a variance transformation.
qqnorm(a3) # This actually looks pretty good - so I'm going to skip the added variance structure. (This is likely thanks to the log transformation.)

# SIDE NOTE: KEEP IN MIND, log-transforming from the start is more powerful than adding in a variance component on the back end!!!

# STEP 4: Fit the lme().

# Using a3 <- lme(logSigma8 ~ Group_3f + Environment, random =~1 | LTER_Site, data = sig)

# STEP 5: Compare the lm() and lme().

anova(a2, a3) # 3 definitely outperforms 2.

# STEP 6: Everything ok? Check residuals.

# See results of Step 3.

# STEP 7/8: Step-wise Optimal Fixed Structure

a3_ml <- lme(logSigma8 ~ Group_3f + Environment, 
             random =~1 | LTER_Site, method = "ML", data = sig) # Switch over to ML for fixed component editing portion.

a4 <- lme(logSigma8 ~ Environment, 
          random =~1 | LTER_Site, method = "ML", data = sig) # Remove Region as a fixed factor.

a5 <- lme(logSigma8 ~ Group_3f, 
          random =~1 | LTER_Site, method = "ML", data = sig) # Remove Environment as a fixed factor.

anova(a3_ml, a4, a5) # Compare the three models. a4 preferred with AIC value of 725.70, so remove Region.

a4full <- lme(logSigma8 ~ Environment, 
              random =~1 | LTER_Site, method = "ML", data = sig)

a4sub1 <- update(a4full, .~. -Environment) # Removes only term.

anova(a4full, a4sub1) # a4full preferred with AIC value of 725.70, so a4full is the final full model!!!

# STEP 9: Refit with REML

afinal <- lme(logSigma8 ~ Environment, 
              random =~1 | LTER_Site, method = "REML", data = sig) # YIPEE!!!

# Output of the model.
summary(afinal)

# Checking residuals.
plot(afinal, col=1) # Not perfect, but no pattern.
qqnorm(afinal) # This makes me feel pretty good.
qqnorm(afinal, ~ranef (.), col = 1) # I'll take it given that we've already log-transformed the data.

# Show intervals.
intervals(afinal)

# Final results.
anova(afinal)

# STEP 10: What does this mean in WORDS?

# I applied a linear mixed effect modelling approach because the data are nested with multiple samples (4+) taken from each site (18) on multiple occasions (2+). My model suggests there is a significant effect of ecosystem/environment type (stream, estuarine, marine) on Sigma 8 concentrations of a given sediment sample. Group (date sampled) and fGroup_3 (region sampled) were not included in the model due to variable selection using AIC values. Random intercepts by site were added.

# Equation: log(Sigma 8) = 0.66 - 0.67[Estuary] - 1.25[Reef] + random[Site]

# BONUS POST HOC:

aHSD <- glht(afinal, linfct=mcp(Environment="Tukey")) # Run a Tukey's post hoc analysis on Environment factor.
summary(aHSD) # All groups significantly different from one another. Note : Use the results of the first run on this function.

# Quick stats calculation of Sigma8 values by environment for the manuscript:

sigmeans <- sig %>%
  group_by(Environment) %>%
  summarize(meanSig8 = mean(Sigma8, na.rm = TRUE), sdSig8 = sd(Sigma8, na.rm = TRUE)) %>% # Calculates summaries ...
  ungroup()

```

The final model took the form : logSigma8 ~ Environment + 1|LTER_Site.

This translates to a formula of log(Sigma8) = 0.66 - 0.67(Estuary) - 1.25(Reef).

Post hoc results: Stream - Estuary, p = 0.0020; Estuary - Reef, p = 0.0016; Stream - Reef, p < 0.001

## Lambda

```{r Lambda, echo=FALSE}

### Data Exploration - boxplots and pairplots

boxplot(Lambda ~ Group_3f, data = mastered) # Boxplot by region. Fixed effect.
boxplot(Lambda ~ Environment, data = mastered) # Boxplot by environment. Fixed effect.
boxplot(Lambda ~ LTER_Site, data = mastered) # Boxplot by sampling site. Random effect.
boxplot(Lambda ~ Group, data = mastered) # Boxplot by sampling site. Random effect.

# So, based on boxplots and Sigma model, I move forward with Group_3f (region) and Environment as fixed variables and Group (date sampled) and Site as random NESTED variables.

lambda <- mastered %>%
  dplyr::select(Group_3f, Environment, LTER_Site, Group, Lambda) %>%
  na.omit # remove NAs and create new dataset.

lambda$Environment <- factor(lambda$Environment, levels = c("Stream", "Estuary", "Reef")) # Puts stream first.

op<- par(mfrow = c(1, 1), mar = c(3, 4, 1, 1))
dotchart(lambda$Lambda, groups = lambda$LTER_Site) # Lambda versus Site on left from original dataset.
par(op) # Looking ok, but we're trying to keep outlier removal to a minimum, so moving on...

pairs(lambda) # Quick pairs plot to check correllated variables. Trends look similar to Sigma 8, and I think I'm on the right path with the fixed/random variables I've chosen.

#### STEP 1: Create a linear regression and check residuals.

# Since the lambda data is normalized to organic carbon content, these values are much more normally distributed than the Sigma8 data. So, I've chosen not to transform the data in any way.

# Response variables - Lambda
# Explanatory variables - Group_3f, Environment

b1 <- lm(Lambda ~ Group_3f + Environment, data = lambda) # Creates the initial linear model.
rb1 <- rstandard(b1) # Assigns standardized residuals to rb1.
plot(rb1 ~ lambda$LTER_Site, xlab = "Site",
     ylab = "Standardised residuals") # Plots said residuals.
abline(0,0) # There looks like there's very little within site correlation, so that will be interesting when it comes time to decide on a random structure.

plot(rb1 ~ lambda$Group, xlab = "Date Sampled",
     ylab = "Standardised residuals") # Plots said residuals.
abline(0,0) # Took a look at date sampled, and it looks similar to site, so I will move forward with only site as part of the random structure (need to account for repeat sampling in some way still).

#### STEP 2: Fit the lm() with GLS and compare to lme().

b2 <- gls(Lambda ~ Group_3f + Environment, data = lambda) # This is effectively a linear regression since it has no additional calls.
b3 <- lme(Lambda ~ Group_3f + Environment, 
          random =~1 | LTER_Site, data = lambda) # Creates the first LMEM with random term.
anova(b2, b3) # Compares the two models. b3 preferred based on AIC value of 1110.23.

# STEP 3: Decide on a variance structure (aka random terms and correlation structure if any).

plot(b3, col=1) # Plots residuals before immediately applying variance transformation.

# Looks like we should add in the varIden() variance structure for the observations in different Ecosystem Types. I am also advocating for this to hopefully address the remaining outlier in this data.

b4 <- lme(Lambda ~ Group_3f + Environment, 
          random =~1 | LTER_Site, data = lambda, 
          weights = varIdent(form =~1 | Environment)) # Allowing for different variance by Ecosystem.

anova(b3, b4) # Compares both models. b4 is better based on an AIC value of 1075.53.

plot(b4, col=1) # Residuals looking better.

# STEP 4: Fit the lme().

# Using b4 <- lme(Lambda ~ Group_3f + Environment, random =~1 | LTER_Site, data = lambda, weights = varIdent(form =~1 | Environment))

# STEP 5: Compare the lm() and lme().

anova(b2, b4) # 4 definitely outperforms 2.

# STEP 6: Everything ok? Check residuals.

# See Step 3.

# STEP 7/8: Step-wise Optimal Fixed Structure

b4_ml <- lme(Lambda ~ Group_3f + Environment, 
             random =~1 | LTER_Site, method = "ML", data = lambda, 
             weights = varIdent(form =~1 | Environment)) # Creates model using ML structure.

b5 <- lme(Lambda ~ Environment, 
          random =~1 | LTER_Site, method = "ML", data = lambda, 
          weights = varIdent(form =~1 | Environment)) # Removes region.

b6 <- lme(Lambda ~ Group_3f, 
          random =~1 | LTER_Site, method = "ML", data = lambda, 
          weights = varIdent(form =~1 | Environment)) # Removes ecosystem.

anova(b4_ml, b5, b6) # Compares all three models. b5 is preferred with AIC value of 1063.45. So, we take out region.

b5full <- lme(Lambda ~ Environment, 
              random =~1 | LTER_Site, method = "ML", data = lambda, 
              weights = varIdent(form =~1 | Environment))

b5sub1 <- update(b5full, .~. -Environment) # Removes only term. Just checking...

anova(b5full, b5sub1) # First term needs to be in there.

# b5full is the final full model!!!

# STEP 9: Refit with REML

bfinal <- lme(Lambda ~ Environment, 
              random =~1 | LTER_Site, method = "REML", data = lambda, 
              weights = varIdent(form =~1 | Environment))

# Output of the model.
summary(bfinal)
plot(bfinal, col=1) # Checking residuals.
qqnorm(bfinal) # A little curvy, but ok.
qqnorm(bfinal, ~ranef (.), col = 1) # Good enough.
intervals(bfinal) # Show intervals.

# Final results.
anova(bfinal)

# STEP 10: What does this mean in WORDS?

# I applied a linear mixed effect modelling approach because the data are nested. My model suggests there is a significant effect of ecosystem type (stream, estuarine, marine) on lambda concentrations of a given sediment sample. fGroup_3 (region sampled) was not included in the model due to variable selection using AIC values. A random intercept by site was added, and variance was treated as varying by Ecosystem Type.

# Equation: Lambda = 2.13 + 0.03[Estuary] - 1.07[Reef] + random + variance

# BONUS : Tukey's HSD Post Hoc
bHSD <- glht(bfinal, linfct=mcp(Environment="Tukey"))

summary(bHSD) # No significant difference between Stream & Estuarine samples.

# Quick stats calculation of Lambda values by environment for the manuscript:

lammeans <- lambda %>%
  group_by(Environment) %>%
  summarize(meanLam = mean(Lambda, na.rm = TRUE), sdLam = sd(Lambda, na.rm = TRUE)) %>% # Calculates summaries ...
  ungroup()

```

The final model took the form : Lambda ~ Environment + 1|LTER_Site + varIdent(Environment)

This translated to a formula of Lambda = 2.13 + 0.03(Estuary) - 1.07(Reef).

Post hoc results: Stream - Estuary, p = 0.994 (NS); Estuary - Reef, p < 0.0001; Stream - Reef, p < 0.0001.

## S/V

```{r S/V, echo=FALSE}

### Data Exploration

boxplot(S.V ~ Group_3f, data = mastered) # Boxplot by region. Fixed effect.
boxplot(S.V ~ Environment, data = mastered) # Boxplot by environment. Fixed effect.
boxplot(S.V ~ LTER_Site, data = mastered) # Boxplot by site. Random effect.
boxplot(S.V ~ Group, data = mastered) # Boxplot by date. Random effect.

# So, based on boxplots and Sigma model, I move forward with Group_3f (region) and Environment as fixed variables and Group (date sampled) and Site as random NESTED variables.

sv <- mastered %>%
  dplyr::select(Group_3f, Environment, LTER_Site, Group, S.V) %>%
  na.omit # remove NAs and create new dataset.

sv$Environment <- factor(sv$Environment, levels = c("Stream", "Estuary", "Reef")) # Puts stream first.

op<- par(mfrow = c(1, 1), mar = c(3, 4, 1, 1))
dotchart(sv$S.V, groups = sv$LTER_Site) # S/V versus Site.
par(op) # Looking ok.

pairs(sv) # Quick pairs plot to check correllated variables. Yep, variable choices still look good.

#### STEP 1: Create a linear regression and check residuals.

# Response variables - S/V
# Explanatory variables - Group_3f, Environment

c1 <- lm(S.V ~ Group_3f + Environment, data = sv) # Creates the linear model.
rc1 <- rstandard(c1) # Assigns standardized residuals to rc1.

plot(rc1 ~ sv$LTER_Site, xlab = "Site",
     ylab = "Standardised residuals") # Plots said residuals.
abline(0,0) # Some within site correlation, so it will definitely be part of a random structure.

plot(rc1 ~ sv$Group, xlab = "Date Sampled",
     ylab = "Standardised residuals") # Plots said residuals.
abline(0,0) # Not quite as extreme as Site, but I still want to include it in my random structure.

#### STEP 2: Fit the lm() with GLS and compare to lme().

c2 <- gls(S.V ~ Group_3f + Environment, data = sv) # Linear regression.
c3 <- lme(S.V ~ Group_3f + Environment, 
          random =~1 | LTER_Site / Group, data = sv) # Creates the first LMEM with random term.
anova(c2, c3) # Compares the two models. c3 preferred with AIC value of 1550.227.

# STEP 3: Decide on a variance structure (aka random terms and correlation structure if any).

c4 <- lme(S.V ~ Group_3f + Environment, random =~1 | Group, data = sv) # Remove Site from random term.
c5 <- lme(S.V ~ Group_3f + Environment, random =~1 | LTER_Site, data = sv) # Remove Date sampled from random term.

anova(c3, c4, c5) # Compares all three models. c3 is still preferred with AIC value of 1517.886.

plot(c3, col=1) # Plots residuals before immediately applying variance transformation. I don't think we need an additional variance structure here.

# STEP 4: Fit the lme().

# Using c3 <- lme(S.V ~ Group_3f + Environment, random =~1 | LTER_Site / Group, data = sv)

# STEP 5: Compare the lm() and lme().

anova(c2, c3) # 3 definitely outperforms 2.

# STEP 6: Everything ok? Check residuals.

plot(c3, col=1) # Residuals look pretty good.
qqnorm(c3) # Looks a little curvy, but not terrible.

# STEP 7/8: Step-wise Optimal Fixed Structure

c3_ml <- lme(S.V ~ Group_3f + Environment, 
             random =~1 | LTER_Site / Group, method = "ML", data = sv) # Creates current model using ML structure.
c6 <- lme(S.V ~ Environment, 
          random =~1 | LTER_Site / Group, method = "ML", data = sv) # Removes region.
c7 <- lme(S.V ~ Group_3f, 
          random =~1 | LTER_Site / Group, method = "ML", data = sv) # Removes ecosystem.
anova(c3_ml, c6, c7) # Compares all three models. c6 preferred with AIC value of 1511.511. So remove region.

c6full <- lme(S.V ~ Environment, 
              random =~1 | LTER_Site / Group, method = "ML", data = sv)
c6sub1 <- update(c6full, .~. -Environment) # Just checking...
anova(c6full, c6sub1) # c6sub1 preferred, with AIC value of 1510.745, but I'm going to keep Environment in to have a structure of comparison.
# c6full is the final full model!!!

# STEP 9: Refit with REML

cfinal <- lme(S.V ~ Environment, 
              random =~1 | LTER_Site / Group, method = "REML", data = sv)

# Output of the model.
summary(cfinal)
plot(cfinal, col=1) # Checking residuals.
qqnorm(cfinal) # I'll take it.
#qqnorm(cfinal, ~ranef (.), col = 1) # Plot of random effect residuals not working, but residuals of the general model look good, so I'm going to go ahead with it.
intervals(cfinal) # Show intervals.

# Final results.
anova(cfinal) # Output for the paper.

# STEP 10: What does this mean in WORDS?

# I applied a linear mixed effect modelling approach because the data are nested. My model suggests there is NO significant effect of either ecosystem type (stream, estuarine, marine) or Region (west to east) on S/V signatures of a given sediment sample. Random nested intercepts by date sampled and site were included.

# Equation: S/V = 2.45 + 0.26[Estuary] + 0.56[Reef] + random

# BONUS : Tukey's HSD Post Hoc
cHSD <- glht(cfinal, linfct=mcp(Environment="Tukey"))
summary(cHSD) # No significant difference between any samples by environment.

# Value calculations for manuscript:

svmeans <- mastered %>% # Takes the original dataset and then ...
  group_by(Environment) %>%     # Groups data and then ...
  summarize(meanSV = mean(S.V, na.rm = TRUE), sdSV = sd(S.V, na.rm = TRUE)) %>% # Calculates summaries ...
  ungroup()

```

The final model took the form : S.V ~ Environment + 1|LTER_Site / Group

This translated to a formula of S/V = 2.45 + 0.26[Estuary] + 0.56[Reef] + random.

Post hoc results: All Environment comparisons, p > 0.05 (NS).

## C/V

```{r C/V, echo=FALSE}

### Data Exploration

boxplot(C.V ~ Group_3f, data = mastered) # Regional boxplot. Fixed effect.
boxplot(C.V ~ Environment, data = mastered) # Environmental boxplot. Fixed effect.
boxplot(C.V ~ LTER_Site, data = mastered) # Site boxplot. Random effect.
boxplot(C.V ~ Group, data = mastered) # Date boxplot. Fixed + random effect?

# So, based on boxplots and Sigma model, I move forward with Group_3 (region), Environment, and Group (date sampled) as fixed variables and Group (date sampled) and Site as random NESTED variables, as with S/V.

cv <- mastered %>%
  dplyr::select(Group_3f, Environment, LTER_Site, Group, C.V) %>%
  na.omit # Create new dataset.

cv$Environment <- factor(cv$Environment, levels = c("Stream", "Estuary", "Reef")) # Puts stream first.

op<- par(mfrow = c(1, 1), mar = c(3, 4, 1, 1))
dotchart(cv$C.V, groups = cv$LTER_Site) # C/V versus Site on left from original dataset.
par(op) # Ok, leaving this for now, and we'll see how the residuals look.

pairs(cv) # Quick pairs plot to check correllated variables. Yep, variable choices still look good. It really looks like there's a trend across time in C.V (suggesting fresher material), but we can't use Group because I think it's too correlated with Environment still.

#### STEP 1: Create a linear regression and check residuals.

# Response variables - C/V
# Explanatory variables - Group_3f, Environment

d1 <- lm(C.V ~ Group_3f + Environment, data = cv) # Initial linear model.
rd1 <- rstandard(d1) # Assigns standardized residuals to rd1.

plot(rd1 ~ cv$LTER_Site, xlab = "Site",
     ylab = "Standardised residuals") # Plots said residuals.
abline(0,0) # Some within site correlation, so it will definitely be part of a random structure.

plot(rd1 ~ cv$Group, xlab = "Date Sampled",
     ylab = "Standardised residuals") # Plots said residuals.
abline(0,0) # Some within sampling date correlation, so it will also be in random structure.

#### STEP 2: Fit the lm() with GLS and compare to lme().

d2 <- gls(C.V ~ Group_3f + Environment, data = cv) # Linear regression.
d3 <- lme(C.V ~ Group_3f + Environment, 
          random =~1 | LTER_Site / Group, data = cv) # Creates the first LMEM with random term.
anova(d2, d3) # Compares the two models. d3 preferred with AIC value of -711.45.

# STEP 3: Decide on a variance structure (aka random terms and correlation structure if any).

d4 <- lme(C.V ~ Group_3f + Environment, 
          random =~1 | Group, data = cv) # Remove Site from random term.
d5 <- lme(C.V ~ Group_3f + Environment, 
          random =~1 | LTER_Site, data = cv) # Remove Date sampled from random term.
anova(d3, d4, d5) # Compares all three models. d3 is still preferred.

plot(d3, col=1) # Plots residuals before immediately applying variance transformation. We need an additional variance structure.

# Looks like we should add in the varIden() variance structure for the observations in different Ecosystem Types.

d6 <- lme(C.V ~ Group_3f + Environment, 
          random =~1 | LTER_Site / Group, data = cv, 
          weights = varIdent(form =~1 | Environment)) # Adding in a variance structure to allow for different variance by ecosystem.
anova(d3, d6) # Compares both models. d6 is better with AIC value of -746.236.

plot(d6, col=1) # Residuals honestly don't look that different.

# I tried this same varident() form with different variances by date, but the "iteration limit reached without convergence" so for simplicity's sake, I'm going to move forward without the additional variance structure.

# STEP 4: Fit the lme().

# Using d3 <- lme(C.V ~ Group_3f + Environment, random =~1 | LTER_Site / Group, data = cv)

# STEP 5: Compare the lm() and lme().

# See Step 2.

# STEP 6: Everything ok? Check residuals.

plot(d3, col=1) # A little trendy <0.1, but I'm going to leave it.
qqnorm(d3) # Looks pretty curvy. But I'm going to move forward without a log-transformation.

# STEP 7/8: Step-wise Optimal Fixed Structure

d3_ml <- lme(C.V ~ Group_3f + Environment, 
             random =~1 | LTER_Site / Group, method = "ML", data = cv) # Creates current model using ML structure.
d7 <- lme(C.V ~ Environment, 
          random =~1 | LTER_Site / Group, method = "ML", data = cv) # Removes region.
d8 <- lme(C.V ~ Group_3f, 
          random =~1 | LTER_Site / Group, method = "ML", data = cv) # Removes ecosystem.
anova(d3_ml, d7, d8) # Compares all three models. d7 is preferred with AIC value of -742.7207. So, I will remove region.

d7full <- lme(C.V ~ Environment, 
              random =~1 | LTER_Site / Group, method = "ML", data = cv)
d7sub1 <- update(d7full, .~. -Environment) # Is Environment necessary?
anova(d7full, d7sub1) # d7full is preferred with an AIC value of -742.7207 so yes!
# d7full is the final full model!!!

# STEP 9: Refit with REML

dfinal <- lme(C.V ~ Environment, 
              random =~1 | LTER_Site / Group, method = "REML", data = cv) # Yay!! 

# Output of the model.
summary(dfinal)
plot(dfinal, col=1) # Checking residuals.
qqnorm(dfinal) # I'll take it.
#qqnorm(dfinal, ~ranef (.), col = 1) # Plot of random effect residuals not working, but residuals of the general model look good, so I'm going to go ahead with it.
intervals(dfinal) # Show intervals.

# Final results.
anova(dfinal) # Output for the paper

# STEP 10: What does this mean in WORDS?

# I applied a linear mixed effect modelling approach because the data are nested. My model suggests there is a significant effect of ecosystem type (stream, estuarine, marine) but not Region (west to east) on C/V signatures of a given sediment sample. Date appeared as if it could be significant, but I was unable to test *both* environment and date simultaneously. So, I settled with focusing on environment given that it was significant for other full dataset measure analyses. Random nested intercepts by date sampled and site were included.

# Equation: C/V = 0.27 + 0.06[Estuary] - 0.17[Reef] + random

# BONUS : Tukey's HSD Post Hoc
dHSD <- glht(dfinal, linfct=mcp(Environment="Tukey"))
summary(dHSD) # No significant difference between Stream & Estuary, but significant between Stream & Reef (p<0.0001) and Estuary & Reef (p<0.0001).

# Value calculations for manuscript:

cvmeans <- mastered %>% # Takes the original dataset and then ...
  group_by(Environment) %>%     # Groups data and then ...
  summarize(meanCV = mean(C.V, na.rm = TRUE), sdCV = sd(C.V, na.rm = TRUE)) %>% # Calculates summaries ...
  ungroup()

```

The final model took the form : C.V ~ Environment + 1|LTER_Site / Group

This translated to a formula of C/V = 0.27 + 0.07[Estuary] - 0.17[Reef] + random.

Post hoc results: Stream - Estuary, p = 0.241 (NS); Stream - Reef, p < 0.0001; Estuary - Reef, p < 0.0001.

##P/V+S

```{r P/V+S, echo=FALSE}

### Data Exploration

boxplot(P..V.S. ~ Group_3f, data = mastered) # Regional boxplot. Fixed effect
boxplot(P..V.S. ~ Environment, data = mastered) # Environment boxplot. Fixed effect.
boxplot(P..V.S. ~ LTER_Site, data = mastered) # Site boxplot. Random effect.
boxplot(P..V.S. ~ Group, data = mastered) # Sampling date boxplot. Random effect. Again, looks like there may be a temporal trend, but I am going to focus on differentiating between environments for now, since I do not feel I can do both.

# So, based on boxplots, I move forward with Group_3f (region) and Environment as fixed variables and Group (date sampled) and Site as random NESTED variables.

pvs <- mastered %>%
  dplyr::select(Group_3f, Environment, LTER_Site, Group, P..V.S.) %>%
  na.omit # Create new dataset.

pvs$Environment <- factor(pvs$Environment, levels = c("Stream", "Estuary", "Reef")) # Puts stream first.

op<- par(mfrow = c(1, 1), mar = c(3, 4, 1, 1))
dotchart(pvs$P..V.S., groups = pvs$LTER_Site) # P/V+S versus Site.
par(op) # Looking ok - I think I'm going to log transform since I'm not taking out any more outliers.

pvs$logPVS <- log10(pvs$P..V.S.) # Makes log-transformed column.

op<- par(mfrow = c(1, 2), mar = c(3, 4, 1, 1))
dotchart(pvs$P..V.S., groups = pvs$LTER_Site) # P/V+S versus Site on left from created dataset.
dotchart(pvs$logPVS, groups = pvs$LTER_Site) # log(P/V+S) versus Site on right from created dataset.
par(op) # Looking way better!!

pairs(pvs) # Quick pairs plot to check correllated variables. Yep, variable choices still look good. Again, looks like there's a trend in time...I'm making the executive decision to focus on investigating between environmental differences for the entire dataset. I will drill down into temporal changes in future models.

#### STEP 1: Create a linear regression and check residuals.

# Response variables - P/V+S
# Explanatory variables - Group_3f, Environment

e1 <- lm(logPVS ~ Group_3f + Environment, data = pvs) # Creates the initial linear model.
re1 <- rstandard(e1) # Assigns standardized residuals to e.j.

plot(re1 ~ pvs$LTER_Site, xlab = "Site",
     ylab = "Standardised residuals") # Plots said residuals.
abline(0,0) # Removing from random structure.

plot(re1 ~ pvs$Group, xlab = "Date Sampled",
     ylab = "Standardised residuals") # Plots said residuals.
abline(0,0) # Including it in my random structure. Again seeing this trend.

#### STEP 2: Fit the lm() with GLS and compare to lme().

e2 <- gls(logPVS ~ Group_3f + Environment, data = pvs) # Linear regression.
e3 <- lme(logPVS ~ Group_3f + Environment, 
          random =~1 | Group, data = pvs) # Creates the first LMEM with random term.
anova(e2, e3) # Compares the two models. e3 preferred with an AIC value of 105.2018.

# STEP 3: Decide on a variance structure (aka random terms and correlation structure if any).

plot(e3, col=1) # Plots residuals before immediately applying variance transformation.

e4 <- lme(logPVS ~ Group_3f + Environment, 
          random =~1 | Group, data = pvs,
          weights = varIdent(form =~1 | Environment)) # Adding in a variance structure to allow for different variance by ecosystem - based on boxplots.

anova(e3, e4) # Compares models. e4 is preferred based on AIC value of 79.24088.

plot(e4, col=1) # Made the slightest difference in residuals.

# I'm going back to the simpler structure of e3.

# STEP 4: Fit the lme().

# Using e3 <- lme(logPVS ~ Group_3f + Environment, random =~1 | Group, data = pvs)

# STEP 5: Compare the lm() and lme().

# See Step #2.

# STEP 6: Everything ok? Check residuals.

plot(e3, col=1) # Residuals look pretty good.
qqnorm(e3) # Looks really quite good!

# STEP 7/8: Step-wise Optimal Fixed Structure

e3_ml <- lme(logPVS ~ Group_3f + Environment, 
             random =~1 | Group, method = "ML", data = pvs) # Creates model using ML structure.
e5 <- lme(logPVS ~ Environment, 
          random =~1 | Group, method = "ML", data = pvs) # Removes region.
e6 <- lme(logPVS ~ Group_3f, 
          random =~1 | Group, method = "ML", data = pvs) # Removes ecosystem.
anova(e3_ml, e5, e6) # Compares all three models. e6 is slightly preferred with an AIC value of 84. 97723. So, remove Environment.

e6full <- lme(logPVS ~ Group_3f, 
              random =~1 | Group, method = "ML", data = pvs)
e6sub1 <- update(e6full, .~. -Group_3f) # Just checking...
anova(e6full, e6sub1) # So removing both fixed variables, e6sub1, is preferred with an AIC value of 81.95200.

#To stick with our "Environment" as a fixed effect theme, I'm going to use e5 going forward.

# STEP 9: Refit with REML

efinal <- lme(logPVS ~ Environment, 
          random = ~1 | Group, method = "REML", data = pvs)

# Output of the model.
summary(efinal)
plot(efinal, col=1) # Checking residuals.
qqnorm(efinal) # I'll take it.
qqnorm(efinal, ~ranef (.), col = 1) # I'm going to go ahead with it.
intervals(efinal) # Show intervals.

# Final results.
anova(efinal) # Output for the paper

# STEP 10: What does this mean in WORDS?

# I applied a linear mixed effect modelling approach because the data are nested. My model suggests there is NO significant effect of either ecosystem type (stream, estuarine, marine) or Region (west to east) on P/V+S signatures of a given sediment sample. Random nested intercepts by date sampled.

# Equation: log(P/V+S) = -0.76 - 0.15[Estuary] - 0.07[Reef] + random

# BONUS : Tukey's HSD Post Hoc
eHSD <- glht(efinal, linfct=mcp(Environment="Tukey"))
summary(eHSD) #  No significant difference between Stream & Estuary, but significant between Stream & Reef (p<0.0001) and Estuary & Reef (p<0.0001).

# Value calculations for manuscript:

pvsmeans <- mastered %>% # Takes the original dataset and then ...
  group_by(Environment) %>%     # Groups data and then ...
  summarize(meanPVS = mean(P..V.S., na.rm = TRUE), sdPVS = sd(P..V.S., na.rm = TRUE)) %>% # Calculates summaries ...
  ungroup()

```

The final model took the form : log(PVS) ~ Environment + 1|Group

This translated to a formula of P/V+S = -0.76 - 0.15[Estuary] - 0.07[Reef] + random.

Post hoc results: NA.

##3,5Bd/V

```{r 35Bd/V, echo=FALSE}

### Data Exploration

boxplot(Bd.V ~ Group_3f, data = mastered) # Regional boxplot. Fixed effect.
boxplot(Bd.V ~ Environment, data = mastered) # Environmental boxplot. Fixed effect.
boxplot(Bd.V ~ LTER_Site, data = mastered) # Site boxplot. Random effect.
boxplot(Bd.V ~ Group, data = mastered) # Date boxplot. Random effect.

# So, based on boxplots, I move forward with Group_3f (region) and Environment as fixed variables and Group (date sampled) and Site as random NESTED variables.

bdv <- mastered %>%
  dplyr::select(Group_3f, Environment, LTER_Site, Group, Bd.V) %>%
  na.omit # Creates a final dataset with no outliers or NAs. 

bdv$Environment <- factor(bdv$Environment, levels = c("Stream", "Estuary", "Reef")) # Puts stream first.

op<- par(mfrow = c(1, 1), mar = c(3, 4, 1, 1))
dotchart(bdv$Bd.V, groups = bdv$LTER_Site) # Bd/V versus Site on left from original dataset.
par(op) # Looking ok - I think I'm going to log transform again.

bdv$logBDV <- log10(bdv$Bd.V) # Makes log-transformed column.

op<- par(mfrow = c(1, 2), mar = c(3, 4, 1, 1))
dotchart(bdv$Bd.V, groups = bdv$LTER_Site) # Bd/V versus Site on left from created dataset.
dotchart(bdv$logBDV, groups = bdv$LTER_Site) # log(Bd/V) versus Site on right from created dataset.
par(op) # Looking way better!!

pairs(bdv) # Quick pairs plot to check correllated variables.

#### STEP 1: Create a linear regression and check residuals.

# Response variables - 3,5-Bd/V
# Explanatory variables - Group_3f, Environment

f1 <- lm(logBDV ~ Group_3f + Environment, data = bdv) # Creates the initial linear model with both fixed variables.
rf1 <- rstandard(f1) # Assigns standardized residuals to rf1.
plot(rf1 ~ bdv$LTER_Site, xlab = "Site",
     ylab = "Standardised residuals") # Plots said residuals.
abline(0,0) # Keeping it as part of a random structure.

plot(rf1 ~ bdv$Group, xlab = "Date Sampled",
     ylab = "Standardised residuals") # Plots said residuals.
abline(0,0) # Not quite as extreme as Site, but I still want to include it in my random structure. This will probably come out...

#### STEP 2: Fit the lm() with GLS and compare to lme().

f2 <- gls(logBDV ~ Group_3f + Environment, data = bdv) # Linear regression.
f3 <- lme(logBDV ~ Group_3f + Environment, 
          random =~1 | LTER_Site / Group, data = bdv) # Creates the first LMEM.
anova(f2, f3) # Compares the two models. f3 preferred with AIC value of 165.1639.

# STEP 3: Decide on a variance structure (aka random terms and correlation structure if any).

f4 <- lme(logBDV ~ Group_3f + Environment, 
          random =~1 | Group, data = bdv) # Remove Site from random term.
f5 <- lme(logBDV ~ Group_3f + Environment, 
          random =~1 | LTER_Site, data = bdv) # Remove Date sampled from random term.
anova(f3, f4, f5) # Compares all three models. f3 is preferred, so keep random term as is.

plot(f3, col=1) # Plots residuals before immediately applying variance transformation. I don't think we need an additional variance structure.

# STEP 4: Fit the lme().

# Using f3 <- lme(logBDV ~ Group_3f + Environment, random =~1 | LTER_Site / Group, data = bdv)

# STEP 5: Compare the lm() and lme().

# See Step 2.

# STEP 6: Everything ok? Check residuals.

plot(f3, col=1) # Residuals look good.
qqnorm(f3) # Looks good!!

# STEP 7/8: Step-wise Optimal Fixed Structure

f3_ml <- lme(logBDV ~ Group_3f + Environment, 
             random =~1 | LTER_Site / Group, method = "ML", data = bdv) # Creates current model using ML structure.
f6 <- lme(logBDV ~ Environment, 
          random =~1 | LTER_Site / Group, method = "ML", data = bdv) # Removes region.
f7 <- lme(logBDV ~ Group_3f, 
          random =~1 | LTER_Site / Group, method = "ML", data = bdv) # Removes ecosystem.
anova(f3_ml, f6, f7) # Compares all three models. f6 is preferred with an AIC value of 143.6322. So, remove Region.

f6full <- lme(logBDV ~ Environment, 
              random =~1 | LTER_Site / Group, method = "ML", data = bdv)
f6sub1 <- update(f6full, .~. -Environment) # Just checking...
anova(f6full, f6sub1) # So keep Environment. f6full has an AIC value of 143.6322.

# STEP 9: Refit with REML

ffinal <- lme(logBDV ~ Environment, 
              random =~1 | LTER_Site / Group, method = "REML", data = bdv) # Final full model.

# Output of the model.
summary(ffinal)
plot(ffinal, col=1) # Checking residuals.
qqnorm(ffinal) # I'll take it.
intervals(ffinal) # Show intervals.

# Final results.
anova(ffinal) # Output for the paper.

# STEP 10: What does this mean in WORDS?

# I applied a linear mixed effect modelling approach because the data are nested. My model suggests there is a significant effect of ecosystem type (stream, estuarine, marine) on 3,5-Bd/V signatures of a given sediment sample. Random nested intercepts by date sampled and site were also included.

# Equation: log(3,5-Bd/V) = -0.77 + 0.009[Estuary] + 0.40[Reef] + random

# BONUS : Tukey's HSD Post Hoc
fHSD <- glht(ffinal, linfct=mcp(Environment="Tukey"))
summary(fHSD) # Significantly different (p<0.0001): Stream & Reef and Estuary & Reef

# Value calculations for manuscript:

bdvmeans <- mastered %>% # Takes the original dataset and then ...
  group_by(Environment) %>%     # Groups data and then ...
  summarize(meanBdv = mean(Bd.V, na.rm = TRUE), sdBdv = sd(Bd.V, na.rm = TRUE)) %>% # Calculates summaries ...
  ungroup()

```

The final model took the form : log(PVS) ~ Environment + 1|LTER_Site / Group

This translated to a formula of log(P/V+S) = -0.77 + 0.009[Estuary] + 0.40[Reef] + random.

Post hoc results: Stream - Estuary, p = 0.996 (NS); Stream - Reef, p < 0.0001; Estuary - Reef, p < 0.0001.

#Stream Data

```{r stream data, include=FALSE}

stream <- read.csv("stream_only_ed.csv") # This imports a stream-data only dataset with watershed characteristics added in (watershed area, land cover, etc.)

streamed <- stream[ -2, ]# Removes the necessary outliers.

```

##Sigma 8 (stream)

```{r Sigma stream, echo=FALSE}

### Data Exploration

sigstream <- streamed %>%
  dplyr::select(LTER_Site, Area, Land_Cover, Group, Sigma8) %>%
  na.omit # Create new dataset. Not testing region any longer since I've decided it's arbitrary.

boxplot(Sigma8 ~ LTER_Site, data = sigstream) # Site boxplot. Random effect.
boxplot(Sigma8 ~ Group, data = sigstream) # Date boxplot. Fixed effect.
boxplot(Sigma8 ~ Area, data = sigstream) # Watershed area boxplot. Fixed effect?
boxplot(Sigma8 ~ Land_Cover, data = sigstream) # Land cover boxplot. Fixed effect.

pairs(sigstream) # Pairs plot. So, I'm going to investigate all three as fixed effects at first, but Site should go in as a random effect too.

#### STEP 1: Create a linear regression and check residuals.

# Response variables - Sigma8
# Explanatory variables - Group, Land_Cover, Watershed Area

g1 <- lm(Sigma8 ~ Group + Land_Cover + Area, data = sigstream) # Creates the initial linear model with all fixed variables.
rg1 <- rstandard(g1) # Assigns standardized residuals to rg1.

plot(rg1 ~ sigstream$LTER_Site, xlab = "Site",
       ylab = "Standardised residuals") # Plots said residuals.
abline(0,0) # Site WILL be used as a random effect.

plot(rg1 ~ sigstream$Group, xlab = "Date",
       ylab = "Standardised residuals") 
abline(0,0) # Group looks all about zero, so removing as a random effect.

plot(rg1 ~ sigstream$Area, xlab = "Watershed Size",
       ylab = "Standardised residuals") 
abline(0,0) # Watershed size looks all about zero.

plot(rg1 ~ sigstream$Land_Cover, xlab = "Land Use",
       ylab = "Standardised residuals") 
abline(0,0) # Same here.

#### STEP 2: Fit the lm() with GLS and compare to lme().

g2 <- gls(Sigma8 ~ Group + Land_Cover + Area, data = sigstream)

g3 <- lme(Sigma8 ~ Group + Land_Cover + Area, 
          random =~1 | LTER_Site, data = sigstream) # Creates the first LMEM.

anova(g2, g3) # Compares the two models. g3 preferred with AIC of 122.1638.

#### STEP 3: Decide on a variance structure (aka random terms).

plot(g3, col=1) # Check the residuals.
qqnorm(g3) # This is ok...

# No additional variance structure necessary.

# STEP 4: Fit the lme().

# Using g3 <- lme(Sigma8 ~ Group + Land_Cover + Area, random =~1 | LTER_Site, data = sigstream)

# STEP 5: Compare the lm() and lme().

# See Step 2.

# STEP 6: Everything ok? Check residuals.

# See Step 3.

# STEP 7/8: Step-wise Optimal Fixed Structure

g3_ml <- lme(Sigma8 ~ Group + Land_Cover + Area, 
          random =~1 | LTER_Site, method = "ML", data = sigstream)
 # Need to switch over to ML for the fixed component editing portion.

g3sub1 <- update(g3_ml, .~. -Group) # Removes Group.
g3sub2 <- update(g3_ml, .~. -Land_Cover) # Removes Land_Cover.
g3sub3 <- update(g3_ml, .~. -Area) # Removes Area.

anova(g3_ml, g3sub1, g3sub2, g3sub3) # Compare the models. sub3 preferred with and AIC value of 130.9081, so remove Area.

g4 <- lme(Sigma8 ~ Group + Land_Cover, 
          random =~1 | LTER_Site, method = "ML", data = sigstream)

g4sub1 <- update(g4, .~. -Group) # Removes Group.
g4sub2 <- update(g4, .~. -Land_Cover) # Removes Land_Cover.

anova(g4, g4sub1, g4sub2) # Compares the models. g4 preferred with an AIC value of 130.9081, so keep them both in.

g4full <- lme(Sigma8 ~ Group + Land_Cover, 
          random =~1 | LTER_Site, method = "ML", data = sigstream) # the final full model!!!

# STEP 9: Refit with REML

gfinal <- lme(Sigma8 ~ Group + Land_Cover, 
             random =~1 | LTER_Site, method = "REML", data = sigstream)

# Output of the model.
summary(gfinal)

# Checking residuals.
plot(gfinal, col=1) # No pattern.
qqnorm(gfinal) # This makes me feel pretty good.
intervals(gfinal) # Show intervals.

# Final results.
anova(gfinal)

# STEP 10: What does this mean in WORDS?

# My model suggests there is NO significant effect of sampling date OR land use/cover on Sigma 8 concentrations of a given stream sediment sample.

# Equation: Sigma 8 = 2.59 + 1.91[GroupC] + 3.39[GroupI] - 1.12[Undeveloped] + 3.09[Urban] + random

# POST HOC: NA


```

The final model took the form : Sigma ~ Group + Land_Cover + 1|LTER_Site

This translated to a formula of Sigma 8 = 2.59 + 1.91[GroupC] + 3.39[GroupI] - 1.12[Undeveloped] + 3.09[Urban] + random

Post hoc results: NA.

## Lambda (stream)

```{r Lambda stream, echo=FALSE}

### Data Exploration

lamstream <- streamed %>%
  dplyr::select(LTER_Site, Area, Land_Cover, Group, Lambda) %>%
  na.omit # Create new dataset.

boxplot(Lambda ~ LTER_Site, data = lamstream) # Site boxplot. Random effect.
boxplot(Lambda ~ Group, data = lamstream) # Date boxplot. Fixed effect.
boxplot(Lambda ~ Area, data = lamstream) # Watershed area boxplot. Fixed effect?
boxplot(Lambda ~ Land_Cover, data = lamstream) # Land cover boxplot. Fixed effect?

pairs(lamstream) # Pairs plot. So, I'm going to investigate all three as fixed effects at first, but Site should go in as a random effect too.

#### STEP 1: Create a linear regression and check residuals.

# Response variables - Lambda
# Explanatory variables - Group, Land_Cover, Watershed Area

h1 <- lm(Lambda ~ Group + Land_Cover + Area, data = lamstream) # Initial linear model.
rh1 <- rstandard(h1) # Assigns standardized residuals to rh1.

plot(rh1 ~ lamstream$LTER_Site, xlab = "Site",
       ylab = "Standardised residuals") # Plots said residuals.
abline(0,0) # Site WILL be used as a random effect.

#### STEP 2: Fit the lm() with GLS and compare to lme().

h2 <- gls(Lambda ~ Group + Land_Cover + Area, data = lamstream)

h3 <- lme(Lambda ~ Group + Land_Cover + Area, 
          random =~1 | LTER_Site, data = lamstream) # Creates the first LMEM.

anova(h2, h3) # Compares the two models. h2 preferred with an AIC value of 60.67366.

#### STEP 3: Decide on a variance structure (aka random terms).
# I'm deciding to keep a random term in to acknowledge the repeated measurement structure of the project design.

plot(h3, col=1) # Check the residuals.
qqnorm(h3) # This actually looks ok...

# Going to skip the extra variance structure.

# STEP 4: Fit the lme().

# Using h3 <- lme(Lambda ~ Group + Land_Cover + Area, random =~1 | LTER_Site, data = lamstream)

# STEP 5: Compare the lm() and lme().

# See Step 2.

# STEP 6: Everything ok? Check residuals.

# See Step 3. 

# STEP 7/8: Step-wise Optimal Fixed Structure

h3_ml <- lme(Lambda ~ Group + Land_Cover + Area, 
          random =~1 | LTER_Site, method = "ML", data = lamstream) # Need to switch over to ML for the fixed component editing portion.
h3sub1 <- update(h3_ml, .~. -Group) # Removes Group.
h3sub2 <- update(h3_ml, .~. -Land_Cover) # Removes Land_Cover.
h3sub3 <- update(h3_ml, .~. -Area) # Removes Area.

anova(h3_ml, h3sub1, h3sub2, h3sub3) # Compare the models. sub2 preferred with an AIC value of 49.25669, so remove Land Cover.

h4 <- lme(Lambda ~ Group + Area, 
          random =~1 | LTER_Site, method = "ML", data = lamstream)
h4sub1 <- update(h4, .~. -Group) # Removes Group.
h4sub2 <- update(h4, .~. -Area) # Removes Area.

anova(h4, h4sub1, h4sub2) # Compares the models. h4 preferred with an AIC value of 49.25669, so keep both terms in.

h4full <- lme(Lambda ~ Group + Area, 
          random =~1 | LTER_Site, method = "ML", data = lamstream)

# STEP 9: Refit with REML

hfinal <- lme(Lambda ~ Group + Area, 
             random =~1 | LTER_Site, method = "REML", data = lamstream)

# Output of the model.
summary(hfinal)

# Checking residuals.
plot(hfinal, col=1) # No pattern.
qqnorm(hfinal) # This looks good.

# Show intervals.
intervals(hfinal)
anova(hfinal)

# STEP 10: What does this mean in WORDS?

# My model suggests there is a significant effect of sampling date but not watershed size on Lambda concentrations of a given stream sediment sample.

# Equation: Lambda = 1.72 + 0.44[GroupC] + 1.87[GroupI] - 0.02[Area] + random

# BONUS POST HOC:

hHSD <- glht(hfinal, linfct=mcp(Group="Tukey"))

summary(hHSD) # Significant different between Jan 2016 and Jan 2017 (p < 0.0001) as well as March 2016 and Jan 2017 (p < 0.0001).

```


This is the end of the RMarkdown document.